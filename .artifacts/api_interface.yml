# 后端API接口定义
# 基于登录页和注册页需求文档生成

- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户登录请求，支持用户名/邮箱/手机号登录
  input:
    type: JSON
    body:
      identifier: string  # 用户名/邮箱/手机号
      password: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录验证通过，需要短信验证"
        requireSmsVerification: true
        sessionId: "uuid"
    error:
      - statusCode: 400
        body: { error: "请输入用户名！" }
      - statusCode: 400
        body: { error: "请输入密码！" }
      - statusCode: 400
        body: { error: "密码长度不能少于6位！" }
      - statusCode: 401
        body: { error: "用户名或密码错误！" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-VerifyPassword
  acceptanceCriteria:
    - 验证输入字段的完整性和格式
    - 支持用户名、邮箱、手机号三种登录方式
    - 密码验证失败时清空密码字段（前端处理）
    - 验证成功后返回会话ID，准备进入短信验证流程
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持多种方式登录验证。"

- type: Backend
  id: API-POST-SendVerificationCode
  route: POST /api/auth/send-verification-code
  description: 发送短信验证码
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string  # 证件号后4位
  output:
    success:
      statusCode: 200
      body: { message: "获取短信验证码成功！" }
    error:
      - statusCode: 400
        body: { error: "请输入正确的用户信息！" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位是否与用户信息匹配
    - 检查发送频率限制（1分钟内只能发送一次）
    - 成功发送后启动60秒倒计时
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码发送功能。"

- type: Backend
  id: API-POST-VerifyLogin
  route: POST /api/auth/verify-login
  description: 验证短信验证码并完成登录
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录成功"
        token: "jwt_token"
        userId: "uuid"
        redirectUrl: "/personal-center"
    error:
      - statusCode: 400
        body: { error: "请输入登录账号绑定的证件号后4位" }
      - statusCode: 400
        body: { error: "请输入验证码" }
      - statusCode: 400
        body: { error: "请输入正确的验证码" }
      - statusCode: 400
        body: { error: "验证码校验失败！" }
      - statusCode: 401
        body: { error: "很抱歉，您输入的短信验证码有误。" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-VerifyCode
    - DB-UpdateUserLoginStatus
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位不能为空
    - 验证码必须为6位数字
    - 验证码必须正确且未过期
    - 验证成功后生成JWT token并更新用户登录状态
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码验证和登录完成。"

- type: Backend
  id: API-GET-HomePage
  route: GET /api/home
  description: 获取12306首页内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        banners: "array"
        announcements: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回首页所需的基本内容
    - 支持Logo点击跳转功能
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持Logo跳转到首页功能。"

- type: Backend
  id: API-GET-ForgotPassword
  route: GET /api/auth/forgot-password
  description: 获取忘记密码页面
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        resetOptions: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回忘记密码页面内容
    - 提供密码重置选项
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持忘记密码页面跳转。"

- type: Backend
  id: API-POST-ValidateUsername
  route: POST /api/register/validate-username
  description: 验证用户名的合法性和可用性
  input:
    type: JSON
    body:
      username: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "用户名可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能超过30个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名只能由字母、数字和_组成，须以字母开头！" }
      - statusCode: 409
        body: { valid: false, error: "该用户名已经占用，请重新选择用户名！" }
  dependencies:
    - DB-FindUserByUsername
  acceptanceCriteria:
    - 验证用户名长度在6-30个字符之间
    - 验证用户名以字母开头
    - 验证用户名只包含字母、数字和下划线
    - 验证用户名在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页用户名实时验证。"

- type: Backend
  id: API-GET-UserProfile
  route: GET /api/user/profile
  description: 获取当前登录用户的个人信息
  input:
    type: Header
    params:
      Authorization: "Bearer token"
  output:
    success:
      statusCode: 200
      body: 
        username: "string"
        name: "string"
        idType: "string"
        idNumber: "string"
        verificationStatus: "string"
        phone: "string"
        email: "string"
        discountType: "string"
    error:
      - statusCode: 401
        body: { error: "未授权或Token失效" }
  dependencies:
    - DB-FindUserById
  acceptanceCriteria:
    - 验证Token有效性
    - 返回包含基本信息、联系方式、附加信息的完整对象
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页展示。"

- type: Backend
  id: API-PUT-UserEmail
  route: PUT /api/user/email
  description: 更新用户邮箱
  input:
    type: JSON
    body:
      email: string
  output:
    success:
      statusCode: 200
      body: { message: "邮箱更新成功" }
    error:
      - statusCode: 400
        body: { error: "邮箱格式不正确" }
      - statusCode: 401
        body: { error: "未授权" }
  dependencies:
    - DB-UpdateUserEmail
  acceptanceCriteria:
    - 验证邮箱格式
    - 更新数据库
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页邮箱修改。"

- type: Backend
  id: API-PUT-UserPhone
  route: PUT /api/user/phone
  description: 更新用户手机号（需先验证原密码和新手机验证码）
  input:
    type: JSON
    body:
      newPhone: string
      verificationCode: string
      password: string
  output:
    success:
      statusCode: 200
      body: { message: "手机号更新成功" }
    error:
      - statusCode: 400
        body: { error: "验证码错误" }
      - statusCode: 400
        body: { error: "密码错误" }
      - statusCode: 401
        body: { error: "未授权" }
  dependencies:
    - DB-VerifyPassword
    - DB-VerifyCode
    - DB-UpdateUserPhone
  acceptanceCriteria:
    - 验证登录密码
    - 验证新手机号的短信验证码
    - 更新手机号
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持手机核验页手机号修改。"

- type: Backend
  id: API-PUT-UserDiscountType
  route: PUT /api/user/discount-type
  description: 更新用户优惠(待)类型
  input:
    type: JSON
    body:
      discountType: string
  output:
    success:
      statusCode: 200
      body: { message: "优惠类型更新成功" }
    error:
      - statusCode: 400
        body: { error: "无效的优惠类型" }
      - statusCode: 401
        body: { error: "未授权" }
  dependencies:
    - DB-UpdateUserDiscountType
  acceptanceCriteria:
    - 验证输入类型
    - 更新数据库
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页优惠类型修改。"

- type: Backend
  id: API-POST-ValidatePassword
  route: POST /api/register/validate-password
  description: 验证密码的合法性
  input:
    type: JSON
    body:
      password: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "密码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "密码长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "格式错误，必须且只能包含字母、数字和下划线中的两种或两种以上！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证密码长度大于等于6位
    - 验证密码只包含字母、数字和下划线
    - 验证密码必须包含字母、数字、下划线中的至少两种
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页密码格式验证。"

- type: Backend
  id: API-POST-ValidateName
  route: POST /api/register/validate-name
  description: 验证姓名的合法性
  input:
    type: JSON
    body:
      name: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "姓名格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "允许输入的字符串在3-30个字符之间！" }
      - statusCode: 400
        body: { valid: false, error: "请输入姓名！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证姓名长度在3-30个字符之间（1个汉字算2个字符）
    - 验证姓名只包含中英文字符、"."和单空格
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页姓名格式验证。"

- type: Backend
  id: API-POST-ValidateIdCard
  route: POST /api/register/validate-idcard
  description: 验证证件号码的合法性和可用性
  input:
    type: JSON
    body:
      idCardType: string
      idCardNumber: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "证件号码格式正确且可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请正确输入18位证件号码！" }
      - statusCode: 400
        body: { valid: false, error: "输入的证件编号中包含中文信息或特殊字符！" }
      - statusCode: 409
        body: { valid: false, error: "该证件号码已经被注册过，请确认是否您本人注册，"是"请使用原账号登录，"不是"请通过铁路12306App办理抢注或持该证件到就近的办理客运业务的铁路车站办理被抢注处理，完成后即可继续注册，或致电12306客服咨询。" }
  dependencies:
    - DB-FindUserByIdCardNumber
  acceptanceCriteria:
    - 验证证件号码长度为18个字符
    - 验证证件号码只包含数字和字母
    - 验证证件号码在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页证件号码验证。"

- type: Backend
  id: API-POST-ValidateEmail
  route: POST /api/register/validate-email
  description: 验证邮箱格式的合法性
  input:
    type: JSON
    body:
      email: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "邮箱格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请输入有效的电子邮件地址！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证邮箱包含"@"符号
    - 验证邮箱包含有效域名
    - 使用标准邮箱格式验证规则
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页邮箱格式验证。"

- type: Backend
  id: API-POST-ValidatePhone
  route: POST /api/register/validate-phone
  description: 验证手机号码的合法性
  input:
    type: JSON
    body:
      phone: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "手机号码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证手机号码长度为11位
    - 验证手机号码只包含数字
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页手机号码格式验证。"

- type: Backend
  id: API-POST-Register
  route: POST /api/register
  description: 处理用户注册请求，创建新用户账户
  input:
    type: JSON
    body:
      username: string
      password: string
      confirmPassword: string
      idCardType: string
      name: string
      idCardNumber: string
      discountType: string
      email: string  # 可选
      phone: string
      agreedToTerms: boolean
  output:
    success:
      statusCode: 201
      body: { message: "注册信息已提交，请进行验证", sessionId: "uuid" }
    error:
      - statusCode: 400
        body: { error: "请填写完整信息！" }
      - statusCode: 400
        body: { error: "确认密码与密码不一致！" }
      - statusCode: 400
        body: { error: "请确认服务条款！" }
      - statusCode: 400
        body: { error: "请修正填写的信息！" }
      - statusCode: 409
        body: { error: "该用户名已经占用，请重新选择用户名！" }
      - statusCode: 409
        body: { error: "该证件号码已经被注册过" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByIdCardNumber
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
  acceptanceCriteria:
    - 验证所有必填字段完整性
    - 验证密码和确认密码一致性
    - 验证用户协议已勾选
    - 验证用户名、证件号码、手机号的唯一性
    - 创建用户会话并返回sessionId用于后续验证
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持用户注册功能。"

- type: Backend
  id: API-POST-SendRegistrationVerificationCode
  route: POST /api/register/send-verification-code
  description: 发送注册验证码（短信和邮箱）
  input:
    type: JSON
    body:
      sessionId: string
      phone: string
      email: string  # 可选
  output:
    success:
      statusCode: 200
      body: { message: "验证码发送成功" }
    error:
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
  dependencies:
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 发送短信验证码到用户手机
    - 如果提供了邮箱，同时发送邮箱验证码
    - 检查发送频率限制
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证码发送功能。"

- type: Backend
  id: API-POST-CompleteRegistration
  route: POST /api/register/complete
  description: 验证验证码并完成用户注册
  input:
    type: JSON
    body:
      sessionId: string
      smsCode: string
      emailCode: string  # 可选
  output:
    success:
      statusCode: 201
      body: { message: "恭喜您注册成功，请到登录页面进行登录！" }
    error:
      - statusCode: 400
        body: { error: "验证码错误或已过期" }
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 500
        body: { error: "注册失败，请稍后重试" }
  dependencies:
    - DB-VerifyCode
    - DB-VerifyEmailCode
    - DB-CreateUser
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证短信验证码
    - 如果提供了邮箱验证码，同时验证邮箱验证码
    - 验证通过后创建用户记录
    - 清理临时会话数据
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证和用户创建功能。"

- type: Backend
  id: API-GET-ServiceTerms
  route: GET /api/terms/service-terms
  description: 获取《中国铁路客户服务中心网站服务条款》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "服务条款"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回服务条款的完整内容
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持服务条款页面访问。"

- type: Backend
  id: API-GET-PrivacyPolicy
  route: GET /api/terms/privacy-policy
  description: 获取《隐私权政策》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "隐私权政策"
        englishTitle: "NOTICE"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回隐私权政策的完整内容
    - 支持中英文标题显示
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持隐私权政策页面访问。"

- type: Backend
  id: API-GET-SearchTrains
  route: GET /api/trains/search
  description: 按出发地、到达地、日期查询直达车次，支持高铁/动车筛选
  input:
    type: Query
    params:
      from: string
      to: string
      date: string
      highspeed: string # '1' 或 '0'，可选
  output:
    success:
      statusCode: 200
      body:
        success: true
        trains: "array"
    error:
      - statusCode: 400
        body: { success: false, message: "缺少必要参数：from、to、date" }
      - statusCode: 500
        body: { success: false, message: "查询失败" }
  dependencies:
    - DB-LoadTrainData
    - DB-ListTrainsByRoute
    - DB-FilterTrainsByType
    - DB-ComputePriceBySeat
  acceptanceCriteria:
    - 当提供有效的 from、to、date 时返回匹配车次列表
    - 当 highspeed=1 时仅返回高铁/动车车次（G/高速、D）
    - 列表项包含车次号、出发/到达站、出发/到达时间、行程历时
    - 列表项包含席别价格字段（商务/一等/二等）
    - 不返回换乘方案，仅直达车次
  changeLog:
    - date: "2025-11-15"
      description: "新增车次查询接口，支持高铁/动车筛选与基础票价。"

- type: Backend
  id: API-GET-TrainDetail
  route: GET /api/trains/:trainNo/detail
  description: 获取指定车次的详细信息
  input:
    type: Path
    params:
      trainNo: string
  output:
    success:
      statusCode: 200
      body:
        success: true
        train: "object"
    error:
      - statusCode: 404
        body: { success: false, message: "车次不存在" }
      - statusCode: 500
        body: { success: false, message: "获取详情失败" }
  dependencies:
    - DB-LoadTrainData
    - DB-GetTrainDetail
  acceptanceCriteria:
    - 当 trainNo 存在时返回完整车次信息
    - 当 trainNo 不存在时返回 404 错误
  changeLog:
    - date: "2025-11-15"
      description: "新增车次详情接口。"

- type: Backend
  id: API-GET-RegionOptions
  route: GET /api/regions
  description: 获取省/市/区县/乡镇/附近区域选项，支持级联
  input:
    type: Query
    params:
      level: string  # province|city|district|town|area
      parentCode: string  # 上一级代码，可选，未选择时返回空
  output:
    success:
      statusCode: 200
      body:
        options: "array"  # [{ code, name }]
    error:
      - statusCode: 400
        body: { error: "参数错误或层级无效" }
  dependencies:
    - DB-LoadRegionHierarchy
    - DB-ListRegionsByParent
  acceptanceCriteria:
    - 在父级未选择时返回空集合，满足越级选择为空的逻辑
    - 返回项包含唯一代码与显示名称
  changeLog:
    - date: "2025-12-13"
      description: "新增行政区划选项查询接口，支持级联选择。"

- type: Backend
  id: API-GET-UserAddresses
  route: GET /api/user/addresses
  description: 获取当前登录用户的车票快递地址列表
  input:
    type: Header
    params:
      Authorization: "Bearer token"
  output:
    success:
      statusCode: 200
      body:
        addresses: "array" # [{ id, recipient, phone, addressText, createdAt, lockedUntil }]
    error:
      - statusCode: 401
        body: { error: "未授权或Token失效" }
  dependencies:
    - DB-ListUserAddresses
  acceptanceCriteria:
    - 按创建时间倒序返回最多20条记录，最新在顶部
    - addressText 为所在地址与详细地址的拼接
  changeLog:
    - date: "2025-12-13"
      description: "新增用户地址列表查询接口。"

- type: Backend
  id: API-POST-UserAddresses
  route: POST /api/user/addresses
  description: 创建新的车票快递地址
  input:
    type: JSON
    body:
      provinceCode: string
      cityCode: string
      districtCode: string
      townCode: string
      areaCode: string  # 可选
      detailAddress: string
      recipient: string
      phone: string
  output:
    success:
      statusCode: 201
      body: { message: "添加成功", id: "uuid" }
    error:
      - statusCode: 400
        body: { error: "请输入详细地址！" }
      - statusCode: 400
        body: { error: "请选择市！" }
      - statusCode: 400
        body: { error: "请选择区/县！" }
      - statusCode: 400
        body: { error: "请选择乡镇（周边地区）！" }
      - statusCode: 400
        body: { error: "您输入的地址中含有非法字符！" }
      - statusCode: 400
        body: { error: "只能包含中文或者英文！" }
      - statusCode: 400
        body: { error: "允许输入的字符串在2-30个字符之间！" }
      - statusCode: 400
        body: { error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 409
        body: { error: "最多可添加20个地址" }
  dependencies:
    - DB-CountUserAddresses
    - DB-CreateAddress
  acceptanceCriteria:
    - 验证所在地址级联选择完整（省/市/区县/乡镇）
    - 验证详细地址、收件人、手机的格式与长度
    - 当用户地址≥20条时返回409
    - 保存成功后返回201，并可在列表中显示
  changeLog:
    - date: "2025-12-13"
      description: "新增创建地址接口，符合PRD表单校验与容量限制。"

- type: Backend
  id: API-PUT-UserAddress
  route: PUT /api/user/addresses/:id
  description: 更新既有地址
  input:
    type: JSON
    body:
      provinceCode: string
      cityCode: string
      districtCode: string
      townCode: string
      areaCode: string  # 可选
      detailAddress: string
      recipient: string
      phone: string
  output:
    success:
      statusCode: 200
      body: { message: "更新成功" }
    error:
      - statusCode: 403
        body: { error: "该地址在30天内不可修改" }
      - statusCode: 400
        body: { error: "校验失败或输入不合法" }
      - statusCode: 404
        body: { error: "地址不存在" }
  dependencies:
    - DB-GetAddressById
    - DB-CheckAddressEditableWithin30Days
    - DB-UpdateAddress
  acceptanceCriteria:
    - 当地址被锁定（近30天内用于已支付订单）时返回403
    - 验证字段与创建接口一致
  changeLog:
    - date: "2025-12-13"
      description: "新增更新地址接口，遵守30天不可修改规则。"

- type: Backend
  id: API-DELETE-UserAddress
  route: DELETE /api/user/addresses/:id
  description: 删除既有地址
  input:
    type: Path
    params:
      id: string
  output:
    success:
      statusCode: 200
      body: { message: "删除成功" }
    error:
      - statusCode: 403
        body: { error: "该地址在30天内不可删除" }
      - statusCode: 404
        body: { error: "地址不存在" }
  dependencies:
    - DB-GetAddressById
    - DB-CheckAddressEditableWithin30Days
    - DB-DeleteAddress
  acceptanceCriteria:
    - 显示删除确认后，确认删除调用该接口
    - 当地址被锁定（近30天内用于已支付订单）时返回403
    - 删除成功后从列表移除
  changeLog:
    - date: "2025-12-13"
      description: "新增删除地址接口，遵守30天不可删除规则。"
