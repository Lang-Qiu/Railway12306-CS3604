import{j as e,u as Q,b as X,r}from"./index-73FoUPY2.js";import{C as $}from"./ConfirmModal-BgI8Vsz2.js";const Y=({trainInfo:n,fareInfo:u,availableSeats:o})=>n?e.jsxs("section",{style:{padding:16},children:[e.jsx("h3",{children:"车次信息"}),e.jsxs("div",{children:["车次：",n.trainNo]}),e.jsxs("div",{children:["出发：",n.departureStation," ",n.departureDate]}),e.jsxs("div",{children:["到达：",n.arrivalStation]}),e.jsx("h4",{children:"席位与票价"}),e.jsx("pre",{children:JSON.stringify(u||{},null,2)}),e.jsx("h4",{children:"余票"}),e.jsx("pre",{children:JSON.stringify(o||{},null,2)})]}):null,Z=({passengers:n,onPassengerSelect:u,availableSeatTypes:o,defaultSeatType:c,selectedPassengers:l,purchaseInfo:g,onSeatTypeChange:k,onTicketTypeChange:b,onDeleteRow:x})=>e.jsxs("section",{style:{padding:16},children:[e.jsx("h3",{children:"乘车人"}),e.jsxs("div",{children:[n.length===0&&e.jsx("div",{children:"暂无乘客"}),n.map(d=>e.jsxs("label",{style:{display:"block"},children:[e.jsx("input",{type:"checkbox",checked:l.includes(d.id),onChange:j=>u(d.id,j.target.checked)})," ",d.name]},d.id))]}),e.jsx("h4",{children:"购票信息"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"乘客"}),e.jsx("th",{children:"票种"}),e.jsx("th",{children:"席别"}),e.jsx("th",{children:"操作"})]})}),e.jsx("tbody",{children:g.map((d,j)=>{var C;return e.jsxs("tr",{children:[e.jsx("td",{children:((C=d.passenger)==null?void 0:C.name)||"-"}),e.jsx("td",{children:e.jsxs("select",{value:d.ticketType,onChange:h=>b(j,h.target.value),children:[e.jsx("option",{value:"成人票",children:"成人票"}),e.jsx("option",{value:"学生票",children:"学生票"})]})}),e.jsx("td",{children:e.jsx("select",{value:d.seatType||c,onChange:h=>k(j,h.target.value),children:o.length?o.map(h=>e.jsx("option",{value:h,children:h},h)):e.jsx("option",{value:c,children:c})})}),e.jsx("td",{children:e.jsx("button",{onClick:()=>x(j),children:"删除"})})]},j)})})]})]}),ee=({onSubmit:n,onBack:u,isSubmitting:o})=>e.jsxs("section",{style:{padding:16},children:[e.jsx("button",{onClick:n,disabled:o,children:"提交订单"}),e.jsx("button",{onClick:u,style:{marginLeft:8},children:"返回车次列表"})]}),te=({onTermsClick:n})=>e.jsxs("section",{style:{padding:16},children:[e.jsx("h4",{children:"温馨提示"}),e.jsx("p",{children:"购买车票请遵守实名制要求，核对信息无误后提交。"}),e.jsx("button",{onClick:n,children:"查看条款"})]}),se=({isVisible:n,orderId:u,onConfirm:o,onBack:c,onSuccess:l})=>n?e.jsx($,{isVisible:n,title:"信息核对",message:`订单已创建，ID：${u}`,confirmText:"确认",cancelText:"返回",onConfirm:l,onCancel:c}):null,re=()=>{const n=Q(),u=X(),{trainNo:o,departureStation:c,arrivalStation:l,departureDate:g}=u.state||{},[k,b]=r.useState(null),[x,d]=r.useState(null),[j,C]=r.useState(null),[h,B]=r.useState([]),[f,w]=r.useState([]),[p,m]=r.useState([]),[I,U]=r.useState("二等座"),[E,T]=r.useState(!1),[N,S]=r.useState(""),[P,M]=r.useState(!1),[J,A]=r.useState(""),[F,O]=r.useState(!1),[L,v]=r.useState(!1),[q,D]=r.useState("");r.useEffect(()=>{const s=localStorage.getItem("authToken");O(!!s);const a=()=>{const t=localStorage.getItem("authToken");O(!!t)};return window.addEventListener("storage",a),()=>window.removeEventListener("storage",a)},[]),r.useEffect(()=>{o&&c&&l&&g?(async()=>{var a;T(!0),S("");try{const t=await fetch(`/api/orders/new/data?trainNo=${encodeURIComponent(o||"")}&origin=${encodeURIComponent(c||"")}&destination=${encodeURIComponent(l||"")}&date=${encodeURIComponent(g||"")}`);if(!t.ok)throw new Error("加载订单页失败");const i=await t.json();b({trainNo:o,departureStation:c,arrivalStation:l,departureDate:g}),d({二等座:{price:((a=i==null?void 0:i.data)==null?void 0:a.unitPrice)||0,available:50}}),C({商务座:0,一等座:0,二等座:30,软卧:0,硬卧:0}),B([]),U("二等座"),m([])}catch(t){S(t.message||"加载订单页失败，请稍后重试")}finally{T(!1)}})():S("缺少必要的车次信息")},[o,c,l,g]);const z=(s,a)=>{const t=h.find(i=>i.id===s);t&&(a?(w([...f,s]),m([...p,{passenger:t,ticketType:"成人票",seatType:I}])):(w(f.filter(i=>i!==s)),m(p.filter(i=>i.passenger.id!==s))))},V=(s,a)=>{const t=[...p];t[s]={...t[s],seatType:a},m(t)},W=(s,a)=>{const t=[...p];t[s]={...t[s],ticketType:a},m(t)},_=s=>{const a=p[s];m(p.filter((t,i)=>i!==s)),w(f.filter(t=>t!==a.passenger.id))},G=()=>{n("/trains",{state:{departureStation:c,arrivalStation:l,departureDate:g}})},H=async()=>{if(f.length===0){D("请选择乘车人！"),v(!0);return}T(!0),S("");try{const s=localStorage.getItem("authToken");if(!s){S("请先登录"),n("/login");return}const a=p.map(y=>{var R;return{passengerId:((R=y.passenger)==null?void 0:R.id)||"p",ticketType:y.ticketType,seatType:y.seatType}}),t=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({trainNo:o,origin:c,destination:l,date:g,seatType:"secondClass",quantity:a.length,passengerNames:a.map(()=>"旅客")})});if(!t.ok){const y=await t.json().catch(()=>({}));throw new Error(y.error||"提交订单失败")}const i=await t.json();A(String(i.orderId||"")),M(!0)}catch(s){D(s.message||"网络忙，请稍后再试。"),v(!0)}finally{T(!1)}},K=async()=>{};return F&&(localStorage.getItem("username")||localStorage.getItem("userId")),e.jsxs("div",{className:"order-page",children:[e.jsx("main",{className:"order-main",children:E?e.jsx("div",{className:"loading",children:"加载中..."}):N?e.jsx("div",{className:"error-message",children:N}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{trainInfo:k,fareInfo:x,availableSeats:j}),e.jsx(Z,{passengers:h,onPassengerSelect:z,onSearchPassenger:()=>{},availableSeatTypes:x?Object.keys(x).filter(s=>x[s].available>0):[],defaultSeatType:I,selectedPassengers:f,purchaseInfo:p,onSeatTypeChange:V,onTicketTypeChange:W,onDeleteRow:_,fareInfo:x}),e.jsx(ee,{onSubmit:H,onBack:G,isSubmitting:E}),e.jsx(te,{onTermsClick:()=>{}})]})}),P&&e.jsx(se,{isVisible:P,orderId:J,onConfirm:K,onBack:()=>M(!1),onSuccess:()=>{n("/")}}),L&&e.jsx($,{isVisible:L,title:"提示",message:q,confirmText:"确认",cancelText:"",onConfirm:()=>v(!1),onCancel:()=>v(!1)})]})};export{re as default};
