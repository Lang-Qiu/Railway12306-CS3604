# 数据库操作接口定义
# 基于登录页和注册页需求文档生成

- type: Database
  id: DB-FindUserByUsername
  description: 根据用户名查找用户信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据用户名精确匹配查找用户记录
    - 返回用户的完整信息包括密码、手机号、证件号等
    - 如果用户不存在，返回空结果
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持登录页用户名验证功能。"

- type: Database
  id: DB-FindUserByEmail
  description: 根据邮箱查找用户信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据邮箱精确匹配查找用户记录
    - 返回用户的完整信息包括密码、手机号、证件号等
    - 如果用户不存在，返回空结果
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持登录页邮箱验证功能。"

- type: Database
  id: DB-FindUserByPhone
  description: 根据手机号查找用户信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据手机号精确匹配查找用户记录
    - 返回用户的完整信息包括密码、手机号、证件号等
    - 如果用户不存在，返回空结果
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持登录页手机号验证功能。"

- type: Database
  id: DB-VerifyPassword
  description: 验证用户密码是否正确
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
  acceptanceCriteria:
    - 接收用户ID和密码，验证密码是否匹配
    - 使用安全的密码比较方法（如bcrypt）
    - 返回验证结果（成功/失败）
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持登录页密码验证功能。"

- type: Database
  id: DB-CreateVerificationCode
  description: 创建并存储短信验证码记录
  dependencies:
    - none
  acceptanceCriteria:
    - 生成6位数字验证码
    - 存储验证码、用户ID、创建时间、过期时间
    - 设置验证码有效期（通常5-10分钟）
    - 记录发送状态和发送时间
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码生成和存储。"

- type: Database
  id: DB-VerifyCode
  description: 验证短信验证码是否正确且未过期
  dependencies:
    - DB-CreateVerificationCode
  acceptanceCriteria:
    - 根据用户ID和验证码查找记录
    - 检查验证码是否匹配
    - 检查验证码是否在有效期内
    - 验证成功后标记验证码为已使用
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码验证功能。"

- type: Database
  id: DB-CheckVerificationCodeFrequency
  description: 检查验证码发送频率限制
  dependencies:
    - DB-CreateVerificationCode
  acceptanceCriteria:
    - 检查用户在指定时间内（1分钟）是否已发送过验证码
    - 返回是否允许发送新验证码的状态
    - 防止验证码发送过于频繁
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持验证码发送频率控制。"

- type: Database
  id: DB-UpdateUserLoginStatus
  description: 更新用户登录状态
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
  acceptanceCriteria:
    - 记录用户最后登录时间
    - 更新用户在线状态
    - 生成或更新用户会话信息
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持用户登录状态管理。"

- type: Database
  id: DB-FindUserByIdCardNumber
  description: 根据证件类型和证件号码查找用户信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据证件类型和证件号码精确匹配查找用户记录
    - 返回用户的完整信息
    - 如果用户不存在，返回空结果
    - 用于检测证件号码是否已被注册
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页证件号码唯一性验证。"

- type: Database
  id: DB-CreateUser
  description: 在数据库中创建新用户记录
  dependencies:
    - none
  acceptanceCriteria:
    - 成功执行后，users表中会增加一条新记录
    - 如果用户名、手机号或证件号已存在，操作应失败并抛出唯一性约束错误
    - 密码应以加密形式存储（如使用bcrypt）
    - 记录创建时间和初始状态
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持用户注册功能。"

- type: Database
  id: DB-CreateEmailVerificationCode
  description: 创建并存储邮箱验证码记录
  dependencies:
    - none
  acceptanceCriteria:
    - 生成6位数字验证码
    - 存储验证码、邮箱地址、创建时间、过期时间
    - 设置验证码有效期（通常5-10分钟）
    - 记录发送状态和发送时间
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持邮箱验证码生成和存储。"

- type: Database
  id: DB-VerifyEmailCode
  description: 验证邮箱验证码是否正确且未过期
  dependencies:
    - DB-CreateEmailVerificationCode
  acceptanceCriteria:
    - 根据邮箱地址和验证码查找记录
    - 检查验证码是否匹配
    - 检查验证码是否在有效期内
    - 验证成功后标记验证码为已使用
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持邮箱验证码验证功能。"

- type: Database
  id: DB-LoadTrainData
  description: 从车次信息.json 加载所有车次基础信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够加载并解析 .trae/documents/2-车票查询与筛选/车次信息.json
    - 若文件不存在或解析失败，返回空集合
  changeLog:
    - date: "2025-11-15"
      description: "新增车次数据加载接口。"

- type: Database
  id: DB-ListTrainsByRoute
  description: 按出发站、到达站和日期筛选直达车次
  dependencies:
    - DB-LoadTrainData
  acceptanceCriteria:
    - 输入参数包含 origin、destination、date
    - 返回符合 origin 和 destination 的直达车次集合
    - 不包含换乘方案
  changeLog:
    - date: "2025-11-15"
      description: "新增按线路筛选车次接口。"

- type: Database
  id: DB-FilterTrainsByType
  description: 按车次类型（高铁/动车等）过滤结果集合
  dependencies:
    - DB-ListTrainsByRoute
  acceptanceCriteria:
    - 当类型包含 GC/D 时，仅保留 G 字头或含“高速”以及 D 字头车次
    - 未指定类型时返回全部结果
  changeLog:
    - date: "2025-11-15"
      description: "新增车次类型过滤接口。"

- type: Database
  id: DB-GetTrainDetail
  description: 根据车次号获取完整车次信息
  dependencies:
    - DB-LoadTrainData
  acceptanceCriteria:
    - 当存在匹配的 train_no 时返回完整对象
    - 不存在时返回空
  changeLog:
    - date: "2025-11-15"
      description: "新增车次详情查询接口。"

- type: Database
  id: DB-ComputePriceBySeat
  description: 计算指定席别在查询区间内的票价
  dependencies:
    - DB-LoadTrainData
  acceptanceCriteria:
    - 票价为途经子区间席别价格的总和（若数据提供）
    - 若缺少价格数据则返回0
  changeLog:
    - date: "2025-11-15"
      description: "新增票价计算接口。"

- type: Database
  id: DB-ComputeSeatAvailability
  description: 计算指定席别在查询区间内的余票数量
  dependencies:
    - DB-LoadTrainData
  acceptanceCriteria:
    - 相邻站查询直接返回对应席别空闲座位数
    - 跨站查询需保证座位在整个区间内持续空闲
    - 当席别不存在时返回占位符
  changeLog:
    - date: "2025-11-15"
      description: "新增余票计算接口，遵循PRD 4.4余票规则。"

- type: Database
  id: DB-FindUserById
  description: 根据用户ID查找用户信息
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据用户ID精确匹配查找用户记录
    - 返回用户的完整信息包括密码、手机号、证件号、邮箱、优惠类型等
    - 如果用户不存在，返回空结果
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页获取当前用户信息。"

- type: Database
  id: DB-UpdateUserEmail
  description: 更新用户邮箱地址
  dependencies:
    - none
  acceptanceCriteria:
    - 根据用户ID更新邮箱字段
    - 验证邮箱格式
    - 返回更新后的用户信息
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页修改邮箱功能。"

- type: Database
  id: DB-UpdateUserPhone
  description: 更新用户手机号码
  dependencies:
    - none
  acceptanceCriteria:
    - 根据用户ID更新手机号字段
    - 确保新手机号未被其他用户绑定
    - 返回更新后的用户信息
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持手机核验页修改手机号功能。"

- type: Database
  id: DB-UpdateUserDiscountType
  description: 更新用户优惠(待)类型
  dependencies:
    - none
  acceptanceCriteria:
    - 根据用户ID更新优惠类型字段
    - 验证类型值是否在允许范围内（学生、儿童、残疾军人、普通）
    - 返回更新后的用户信息
  changeLog:
    - date: "2025-12-08"
      description: "初始创建，支持个人信息页修改优惠类型功能。"

- type: Database
  id: DB-LoadRegionHierarchy
  description: 加载省/市/区县/乡镇/附近区域的行政区划层级数据
  dependencies:
    - none
  acceptanceCriteria:
    - 能够加载五级行政区划层级数据并提供查询
    - 数据包含唯一代码与显示名称，支持级联查询
    - 当上级未选择时，下级查询返回空集合
  changeLog:
    - date: "2025-12-13"
      description: "新增地址管理所需的行政区划层级数据加载接口。"

- type: Database
  id: DB-ListRegionsByParent
  description: 根据层级与父级代码列出下一级行政区划选项
  dependencies:
    - DB-LoadRegionHierarchy
  acceptanceCriteria:
    - 输入包含 level（province/city/district/town/area）与 parentCode
    - 在父级未选择时返回空集合
    - 返回项包含 { code, name }
  changeLog:
    - date: "2025-12-13"
      description: "新增按父级代码列出行政区划选项接口。"

- type: Database
  id: DB-ListUserAddresses
  description: 列出用户的车票快递地址，按创建时间倒序
  dependencies:
    - none
  acceptanceCriteria:
    - 输入为用户ID
    - 返回最多20条地址记录，按 createdAt 倒序
    - 每条记录包含 { id, recipient, phone, regionPath, detailAddress, createdAt, lockedUntil }
  changeLog:
    - date: "2025-12-13"
      description: "新增用户地址列表查询接口。"

- type: Database
  id: DB-GetAddressById
  description: 根据地址ID获取地址详情
  dependencies:
    - none
  acceptanceCriteria:
    - 能够根据地址ID精确匹配查找地址记录
    - 返回完整地址对象
    - 地址不存在时返回空结果
  changeLog:
    - date: "2025-12-13"
      description: "新增按ID获取地址详情接口。"

- type: Database
  id: DB-CountUserAddresses
  description: 统计用户已保存的地址数量
  dependencies:
    - none
  acceptanceCriteria:
    - 输入为用户ID
    - 返回整数数量，用于校验最多20条限制
  changeLog:
    - date: "2025-12-13"
      description: "新增用户地址数量统计接口。"

- type: Database
  id: DB-CheckAddressEditableWithin30Days
  description: 检查地址在近30天内是否因已支付订单而被锁定不可编辑/删除
  dependencies:
    - DB-GetAddressById
  acceptanceCriteria:
    - 输入为地址ID
    - 若该地址被用于已支付订单且在30天有效期内，返回不可编辑/删除状态
    - 返回 { editable: boolean, deletable: boolean, lockedUntil: datetime }
  changeLog:
    - date: "2025-12-13"
      description: "新增地址30天锁定状态检查接口。"

- type: Database
  id: DB-CreateAddress
  description: 在数据库中创建新的车票快递地址记录
  dependencies:
    - DB-CountUserAddresses
  acceptanceCriteria:
    - 当用户地址数量已达20条时操作失败并返回唯一性/容量限制错误
    - 验证必填字段：省/市/区县/乡镇、详细地址、收件人、手机
    - 详细地址仅允许数字、英文、汉字
    - 收件人仅允许中文或英文，长度2-30个字符（英文≥2，中文≥1）
    - 手机号必须为11位纯数字
    - 成功执行后新增记录并返回创建的地址对象
  changeLog:
    - date: "2025-12-13"
      description: "新增创建地址接口，含字段校验与20条限制。"

- type: Database
  id: DB-UpdateAddress
  description: 更新既有的车票快递地址记录
  dependencies:
    - DB-GetAddressById
    - DB-CheckAddressEditableWithin30Days
  acceptanceCriteria:
    - 在地址被锁定（近30天内用于已支付订单）时拒绝修改
    - 验证必填字段与格式要求与创建一致
    - 返回更新后的地址对象
  changeLog:
    - date: "2025-12-13"
      description: "新增更新地址接口，遵守30天不可修改规则。"

- type: Database
  id: DB-DeleteAddress
  description: 删除既有的车票快递地址记录
  dependencies:
    - DB-GetAddressById
    - DB-CheckAddressEditableWithin30Days
  acceptanceCriteria:
    - 在地址被锁定（近30天内用于已支付订单）时拒绝删除
    - 删除成功后不再出现在列表中
  changeLog:
    - date: "2025-12-13"
      description: "新增删除地址接口，遵守30天不可删除规则。"
