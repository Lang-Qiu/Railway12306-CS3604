# 挑战与解决方案：LLM 驱动开发中的实战反思

在探索“需求-设计-测试-实现”全链路闭环的过程中，我们并未一帆风顺。虽然 LLM 展现了强大的生成能力，但在面对严肃的工程化落地时，依然面临着**“不可控”**与**“幻觉”**的双重挑战。以下是我们的深度复盘与应对策略。

## 挑战一：PRD "一步到位" 的不可行性与模型幻觉
> *“试图让 AI 一口气吃成胖子，结果往往是消化不良。”*

### 1. 现象描述
*   **长文本失控**：当我们尝试将包含完整业务逻辑（如“12306 完整购票流程”）的长篇 PRD 直接投喂给模型，要求其生成整个模块时，生成的代码往往逻辑断层、关键细节丢失。
*   **微调地狱**：生成的初稿虽然框架看似完整，但细节错误百出（如变量名不统一、API 路径错误），导致后续需要人工进行大量的“修补工作”，效率甚至低于手写。
*   **幻觉与稳定性**：模型经常“自作聪明”地臆造不存在的 API 接口，或者每次生成的逻辑都不一样，导致代码无法稳定复现，测试用例也随之频繁失效。

### 2. 解决方案：拆解与约束 (Decomposition & Constraint)
我们放弃了“端到端生成”的幻想，转而采用**“分而治之”**的策略：

*   **A. 原子化拆解 (Atomic Decomposition)**：
    *   不直接生成“订单模块”，而是将其拆解为 `OrderEntity` (数据结构)、`createOrder` (原子函数)、`API Endpoint` (接口层)。
    *   **Prompt 策略**：每次只让 AI 专注实现一个具体的函数或组件，上下文更聚焦，幻觉大幅降低。

*   **B. 接口先行 (Interface First Design)**：
    *   **强制约束**：在生成具体代码前，先定义好 YAML 格式的接口文档 (`artifacts/*.yaml`)。
    *   **AI 的“镣铐”**：要求 AI 必须严格遵循已定义的 YAML 接口签名进行实现。如果 AI 试图臆造新接口，会被强制纠正。

*   **C. 迭代式微调 (Iterative Refinement)**：
    *   不追求一次完美。先生成 V0.1 版本，通过自动化测试发现问题，再将错误日志作为新的 Prompt 反馈给 AI，让其进行“定向修复”。

---

## 挑战二：AI 对数据库管理的混乱与数据污染
> *“AI 总是喜欢往数据库里塞‘私货’。”*

### 1. 现象描述
*   **Schema 漂移**：AI 在修改业务逻辑时，经常随意修改数据库 Schema（如擅自改名 `user_id` 为 `uid`），导致旧数据无法读取。
*   **脏数据注入**：为了方便它自己的逻辑跑通，AI 经常会在代码中硬编码插入各种“张三”、“李四”的示例数据，甚至在生产逻辑中混入 Mock 数据。
*   **状态不可控**：测试运行几次后，数据库里充斥着重复的垃圾数据，导致后续测试（如“用户名唯一性校验”）必定失败。

### 2. 解决方案：严格隔离与数据治理 (Isolation & Governance)

*   **A. 数据库访问层隔离 (DAL Isolation)**：
    *   禁止 AI 直接在业务逻辑中写 SQL 或操作 DB。
    *   **封装**：所有数据库操作必须通过 `dbService.js` 或 `jsonDbService.js` 进行。AI 只能调用这些经过人工审查的“安全方法”。

*   **B. 测试环境沙箱化 (Sandbox Environment)**：
    *   **构想与实践**：实现“测试即重置”机制。在每次自动化测试运行前，利用脚本 (`run_tests.py` 中的 setup 钩子) 将数据库重置为初始的“黄金快照” (Golden Snapshot)。
    *   **文件级隔离**：使用 SQLite/JSON DB 的文件特性，测试时复制一份 `test.db`，测试结束后直接删除，确保不污染主库。

*   **C. Schema 锁定策略**：
    *   将数据库结构定义（SQL DDL）放入只读文件 (`schema.sql`)。
    *   在 Prompt 中明确指令：**“严禁修改现有的表结构，只能进行增删改查操作。”**

---

## 3. 总结
我们通过**“将大任务拆小”**解决了模型幻觉问题，通过**“将数据关进笼子”**解决了数据库混乱问题。
这证明了在 LLM 辅助开发的当下，**“工程化约束”**依然是不可或缺的核心能力。AI 是强大的引擎，但我们需要为其铺设轨道（接口约束）并安装刹车（测试验证）。
